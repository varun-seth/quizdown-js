<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width,initial-scale=1'>

    <title>Quiz with Monaco Editor</title>

    <script src="./build/quizdown.js"></script>
    <script src="./build/extensions/quizdownKatex.js"></script>
    <script src="./build/extensions/quizdownHighlight.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.20.0/min/vs/loader.js"></script>

    <style>
        html, body {
            font-family: sans-serif;
            height: 100%;
            margin: 0;
        }
        #editorContainer, #quizContainer {
            height: 100%;
            width: 50%;
            float: left;
        }
        .container {
            display: flex;
            height: 100vh;
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="editorContainer"></div>
        <div id="quizContainer"></div>
    </div>

    <script>
        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.20.0/min/vs' }});
        require(['vs/editor/editor.main'], function() {
			function getSavedContent() {
				// Try getting content from sessionStorage first, then localStorage
				var savedContent = sessionStorage.getItem('liveEditorContent') || localStorage.getItem('markdownContent');
				if (savedContent) {
					return savedContent;
				} else {
					return [
                    '## What is 2 + 2 ?',
                    '- [x] 4',
					'- [ ] 5'
                ].join('\n'); // Default content if nothing is saved
				}
			}

            var editor = monaco.editor.create(document.getElementById('editorContainer'), {
                value: getSavedContent(),
                language: 'markdown',
				minimap: { enabled: false },
            });

            editor.onDidChangeModelContent(function() {
				var currentContent = editor.getValue();
                renderQuiz(editor.getValue());
				sessionStorage.setItem('liveEditorContent', currentContent);
		        localStorage.setItem('liveEditorContent', currentContent);
            });

			// Intercept Ctrl+S and Command+S
			editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KEY_S, function() {
				var content = editor.getValue();
				downloadContent(content, "quiz.md");
			});



            renderQuiz(editor.getValue());
        });

		function downloadContent(content, filename) {
			var element = document.createElement('a');
			element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(content));
			element.setAttribute('download', filename);

			element.style.display = 'none';
			document.body.appendChild(element);

			element.click();

			document.body.removeChild(element);
		}


        function renderQuiz(markdown) {
            const quizContainer = document.getElementById('quizContainer');
            quizContainer.innerHTML = ''; // Clear previous content
            const newQuizElement = document.createElement('div');
            newQuizElement.className = 'quizdown';
            quizContainer.appendChild(newQuizElement);

            let config = {
                "shuffleAnswers": false,
                "shuffleQuestions": false,
                "primaryColor": "#316FF6",
                "secondaryColor": "#f8f8f8",
            };
            quizdown.register(quizdownKatex).register(quizdownHighlight).createApp(markdown, newQuizElement, config);
        }
    </script>
</body>

</html>
